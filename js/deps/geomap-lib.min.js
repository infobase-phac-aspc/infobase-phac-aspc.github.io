/*
 * @title WET-BOEW Geomap
 * @overview Displays a dynamic map over which information from additional sources can be overlaid.
 * @license wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html
 * @author @pjackson28
 */
!function(a,b,c,d){"use strict";var e,f,g,h,i="wb-geomap",j="."+i,k=d.doc,l=2e3,m=0,n=0,o=[],p=!1,q={config:{controls:[],autoUpdateSize:!0,fractionalZoom:!0,theme:null},overlays:[],features:[],tables:[],useScaleLine:!1,useMousePosition:!1,debug:!1,useLegend:!1,useTab:!1,useMapControls:!0},r=function(e){var l,n,o,r=e.target,t=r.className,u={};e.currentTarget===r&&(l=a(r),n=d.getMode()+".js",h||(g=d.i18n,h={close:g("close"),colon:g("colon"),hiddenLayer:g("geo-hdnlyr"),toggleLayer:g("geo-tgllyr"),labelSelect:g("geo-lblsel"),select:g("geo-sel"),zoomFeature:g("geo-zmfeat"),zoomin:g("geo-zmin"),zoomout:g("geo-zmout"),zoomwrld:g("geo-zmwrld"),baseMapTitle:g("geo-bmapttl"),baseMapURL:g("geo-bmapurl"),baseMapURLTxt:g("geo-bmapurltxt"),scaleline:g("geo-sclln"),mouseposition:g("geo-msepos"),access:g("geo-ally"),accessTitle:g("geo-allyttl"),attribLink:g("geo-attrlnk"),attribTitle:g("geo-attrttl"),ariaMap:g("geo-ariamap")}),o={useScaleLine:-1!==t.indexOf("scaleline")?!0:void 0,useMousePosition:-1!==t.indexOf("position")?!0:void 0,debug:-1!==t.indexOf("debug")?!0:void 0,useLegend:-1!==t.indexOf("legend"),useTab:-1!==t.indexOf("tab"),useMapControls:-1!==t.indexOf("static")?!1:!0},a.extend(u,q,o,b[i],d.getData(l,i)),l.data({settings:u}),p=u.debug,b.Proj4js={Proj:function(a){return proj4(b.Proj4js.defs[a])},defs:proj4.defs,transform:proj4},OpenLayers.Lang.setCode(c.documentElement.lang),OpenLayers.ImgPath=d.getPath("/assets")+"/",proj4.defs("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"),p&&(Modernizr.load([{load:"site!../assets/geomap-debug"+n}]),k.trigger("debug"+j)),m+=1,f=s(l),u.layersFile?a.ajax({url:u.layersFile,dataType:"script",async:!1,success:function(){a.extend(u,wet_boew_geomap),W(f,u),p&&k.trigger("overlayLoad"+j)},error:function(){p&&k.trigger("overlayNotLoad"+j)}}):(W(f,u),p&&k.trigger("overlayNotSpecify"+j)),f.overlays||Z(f))},s=function(a){var b={uniqueId:m,mapid:a.attr("id"),map:null,selectControl:null,showAttribNRCan:!1,queryLayers:[],overlays:0,overlaysLoaded:0,overlaysLoading:{}},c=a.find(".wb-geomap-map");return b.gmap=c.attr("id","geomap-map-"+m).height(.8*c.width()),b.glegend=a.find(".wb-geomap-legend").attr("id","geomap-legend-"+m),b.glayers=a.find(".wb-geomap-layers").attr("id","geomap-layers-"+m),b},t=function(a){var b=new OpenLayers.Control.PanZoom;OpenLayers.Util.extend(b,{draw:function(){var a,b=this,c=["zoomin","zoomout","zoomworld"],d=["zoom-plus-mini","zoom-minus-mini","zoom-world-mini"],e=c.length;for(OpenLayers.Control.prototype.draw.apply(b,arguments),b.buttons=[],a=0;a!==e;a+=1)b._addButton(c[a],d[a]+".png");return b.div}}),a.map.addControl(b),u(a)},u=function(a){var b,c,d,e,f,g=a.gmap.find(".olControlPanZoom")[0],i=g.getElementsByTagName("div"),j=i.length;for(g.setAttribute("role","toolbar"),b=0;b!==j;b+=1)c=i[b],d=c.getElementsByTagName("img")[0],d&&(f=c.action,e=h[f],c.setAttribute("aria-label",e),c.setAttribute("title",e),c.setAttribute("role","button"),c.className+=" olControl"+f,c.tabIndex=0,d.setAttribute("alt",e),d.className+=" olControl"+f)},v=function(b){var c=b.id.replace(/\W/g,"_");a("#"+c).addClass("background-highlight"),a("#cb_"+c).prop("checked",!0)},w=function(b){var c=b.id.replace(/\W/g,"_"),d=b.popup;a("#"+c).removeClass("background-highlight"),a("#cb_"+c).prop("checked",!1),d&&d.visible()&&d.hide()},x=function(a){var b=a.layer.map.getControlsByClass("OpenLayers.Control.SelectFeature")[0];a._lastHighlighter?b.unselect(a):(b.select(a),a.layer.popups&&(e&&e.popup&&e.popup.visible()&&e.popup.hide(),a.popup?a.popup.toggle():y(a)))},y=function(a){var b,d,e,g,i,j,k,l,m,n,o,p=a.layer.popupsInfo,q=a.id.replace(/\W/g,"_"),r=h.close,s=h.colon,t=a.layer.map.size,u="<h3>"+c.getElementById(a.layer.name).getAttribute("aria-label")+"</h3>";if(p){m=p.id,n=p.width,o=p.height,b=(m?m:"popup_")+"_"+q,d=o?o:t.h/2,e=n?n:t.w/2,g=n?p.close:!0,u+=p.content;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(l=new RegExp("_"+i,"igm"),u=u.replace(l,a.attributes[i]))}else{b="popup_"+q,d=t.h/2,e=t.w/2,g=!0;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(u+="<p><strong>"+i+s+"</strong><br />"+a.attributes[i]+"</p>")}j=new OpenLayers.Popup.FramedCloud(b,a.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(e,d),u,null,g,null),j.maxSize=new OpenLayers.Size(e,d),a.popup=j,a.layer.map.addPopup(j),k=c.createElement("span"),k.className="glyphicon glyphicon-remove-circle close_"+q,k.setAttribute("data-map",f.mapid),k.setAttribute("data-layer",a.layer.id),k.setAttribute("data-feature",a.id),k.setAttribute("aria-label",r),k.setAttribute("title",r),k.setAttribute("role","button"),k.setAttribute("tabindex","0"),a.popup.closeDiv.appendChild(k)},z=function(){p&&!a(".wb-geomap-legend").length&&k.trigger("warningLegend"+j)},A=function(a,b){if(b){var c=a.glayers.find(".wb-geomap-tabs");0!==c.length?c.attr({"class":"wb-tabs auto-height-none",id:"geomap-tabs-"+m}):a.glayers.prepend("<div id='geomap-tabs-"+m+"' class='wb-geomap-tabs wb-tabs auto-height-none' style='width: "+a.glayers.width()+"px;'>")}},B=function(b,c,d,e){return a("<table class='table "+(e?" wb-tables":" table-condensed")+"' aria-label='"+c+"' id='overlay_"+b+"'><caption>"+d+"</caption><thead></thead><tbody></tbody></table>")},C=function(b,c,d,e,f){0!==b.glegend.length&&D(b,c,d,e);var g=b.glayers,i=c[0].id,l=a("<div id='tabs_"+i+"'>"),m=c[0].attributes["aria-label"].value,n=a("<h3>"+m+"</h3>"),o=a("<div id='msg_"+i+"' class='alert alert-warning'><p>"+h.hiddenLayer+"</p></div>");p&&0===g.length&&k.trigger("layersNotSpecify"+j),f&&0!==a(".wb-geomap-tabs").length?H(b,c,d,e):(l.append(n,c),g.append("<div class='col-md-12'>"+l.html()+"</div>"),d||(l.append(o),c.fadeOut())),p&&f&&0===a(".wb-geomap-tabs").length&&k.trigger("warningTab"+j)},D=function(b,c,d,e){var f,g,i,j,k,l,m=a(c),n=c[0].id,o=b.glegend;b.glegend&&(f=o.find("fieldset"),0===f.length&&(f=o.append("<fieldset name='legend'><legend class='wb-inv'>"+h.toggleLayer+"</legend></fieldset>")),i=d?"checked='checked'":"",g=o.find("ul"),0===g.length&&(g=a("<ul class='list-unstyled'></ul>").appendTo(f)),j=a("<input type='checkbox' id='cb_"+n+"' class='geomap-lgnd-cbx' value='"+n+"' "+i+" data-map='"+b.mapid+"' data-layer='"+e+"' />"),k=a("<label>",{"for":"cb_"+n,text:m.attr("aria-label")}).prepend(j),l=a("<li class='checkbox'>").append(k,"<div id='sb_"+n+"'></div>"),g.append(l))},E=function(b){var c,d,e,f,g,i,j,k,l,m,n,o,p=b.map.layers.length,q=h.colon;for(m=0;m!==p;m+=1)if(f=b.map.layers[m],!f.isBaseLayer&&(d=a("#sb_"+f.name),e="",d.length)){if(g=f.styleMap.styles["default"],i=g.defaultStyle,c=g.rules.length){for(e+="<ul class='list-unstyled'>",n=0;n!==c;n+=1)o=g.rules[n],j=o.filter,k=j.type,"=="===k&&(k=q),l=o.symbolizer,e+="<li class='margin-bottom-medium'>"+j.property+" "+(null!==j.value?k+" "+j.value:j.lowerBoundary+" "+k+" "+j.upperBoundary+"</label>")+F(l)+"</li>";e+="</ul>"}else i.fillColor?e+=F(i):i.externalGraphic&&(e+=G(i));d.append(e)}},F=function(a){var b="",c=a.fillColor,d=a.strokeColor,e=a.fillOpacity;return c&&(b+="background-color: "+c+";"),d&&(b+="border-style: solid; border-width: 2px; border-color: "+d+";"),e&&(b+="opacity: "+e+";"),"<div class='geomap-legend-symbol'"+(""!==b?" style='"+b+"'/>":"/>")},G=function(a,b){var c="",d=b?b:"",e=a.graphicOpacity,f=a.pointRadius,g=a.graphicHeight,h=a.graphicWidth;return e&&(c+="opacity: "+e+";"),f?c+="height: "+f+"px; width: "+f+"px;":g&&h&&(c+="height: "+g+"px; width: "+h+"px;"),"<img src='"+a.externalGraphic+"' alt='"+d+(""!==c?"' style='"+c+"' />":"' />")},H=function(b,c,d){var e,f=b.glayers.find(".wb-geomap-tabs"),g=f.find("ul"),i=c[0].id,j=a(c),k=j.attr("aria-label");e=a("<details>",{id:"details-"+i}).append("<summary>"+k+"</summary>",c),g.append("<li><a href='#tabs_"+i+"'>"+k+"</a></li>"),f.append(e),d||(e.append("<div id='msg_"+i+"'><p>"+h.hiddenLayer+"</p></div>"),c.fadeOut())},I=function(a){var b,c,e,f,g,h,i,j,k,l,m,o,p=d.drawColours[n],q=p,r={strokeColor:p,fillColor:q,fillOpacity:.5,pointRadius:5,strokeWidth:.5},s={strokeColor:"#00f",fillColor:"#00f",fillOpacity:.4,strokeWidth:2},t=a.style;if(n+=1,n===d.drawColours.length&&(n=0),t)if(j=t.type,m=t.select,k={select:new OpenLayers.Style(m?m:s)},"rule"===j){for(e=[],i=new OpenLayers.Style,l=t.rule,h=l.length,g=0;g!==h;g+=1)f=l[g],o=f.filter,c={type:OpenLayers.Filter.Comparison[o],property:f.field},"BETWEEN"!==o?c.value=f.value[0]:(c.lowerBoundary=f.value[0],c.upperBoundary=f.value[1]),e.push(new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison(c),symbolizer:f.init}));k["default"]=i.addRules(e)}else"unique"!==j&&(k["default"]=new OpenLayers.Style(t.init));else k={"default":new OpenLayers.Style(r),select:new OpenLayers.Style(s)};return b=new OpenLayers.StyleMap(k),t&&"unique"===j&&b.addUniqueValueRules("default",t.field,t.init),b},J=function(a,b,c,d){var e,f,g=b.feature,i=g.attributes,j="head"===b.type,k=g.id.replace(/\W/g,"_");e=j?"<tr><th>"+h.select+"</th>":"<tr id='featureId'>"+N(a,g,k);for(f in i)i.hasOwnProperty(f)&&(e+=j?"<th>"+f+"</th>":"<td>"+i[f]+"</td>");return c&&(j?d&&(e+="<th>"+h.zoomFeature+"</th>"):e+=O(a,b.feature)),e+"</tr>"},K=function(b,e,f,g,h,i){var j,k,l={type:"head",feature:f.features[0]},m=c.getElementById(e.attr("id")),n=m.getElementsByTagName("thead")[0],o=m.getElementsByTagName("tbody")[0],p=b.selectControl,q=f.features,r=q.length,s=/\W/g,t=J(b,l,g,i),u=o.innerHTML;for(k=0;k!==r;k+=1)j=q[k],u+=J(b,{type:"body",id:j.id.replace(s,"_"),feature:j,selectControl:p},g,i);d.ielt9?(a(n).html(t),a(o).html(u)):(n.innerHTML=t,o.innerHTML+=u)},L=function(a){a.gmap.find(".olTileImage").attr("alt",""),a.overlaysLoaded+=1,a.overlays===a.overlaysLoaded&&(Z(a),a.overlays=0,a.overlaysLoaded=0)},M=function(b,e,f,g){var h=e.id.replace(/\W/g,"_"),i=c.getElementById(h),j=N(b,e,h)+i.innerHTML+(g&&f?O(b,e):"");d.ielt9?a(i).html(j):i.innerHTML=j},N=function(a,b,c){return"<td><label class='wb-inv' for='cb_"+c+"'>"+h.labelSelect+"</label><input type='checkbox' id='cb_"+c+"' class='geomap-cbx' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' /></td>"},O=function(a,b){return"<td><a href='javascript:;' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' class='btn btn-default btn-sm geomap-zoomto'>"+h.zoomFeature+"</a></td>"},P=function(a){var b,c=a.gmap.width(),d={name:h.baseMapTitle,url:h.baseMapURL,layer:h.baseMapTitle,matrixSet:"nativeTileMatrixSet",tileSize:new OpenLayers.Size(256,256),format:"image/jpg",style:"default",requestEncoding:"REST",isBaseLayer:!0,isSingleTile:!1,tileOrigin:new OpenLayers.LonLat(-34655800,3931e4),zoomOffset:5,resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215],transitionEffect:"resize"};for(p&&k.trigger("basemapDefault"+j),c>260&&500>=c?d.zoomOffset=1:c>500&&725>=c?d.zoomOffset=2:c>725&&1175>=c?d.zoomOffset=3:c>1175&&2300>=c&&(d.zoomOffset=4),b=d.zoomOffset-1;-1!==b;b-=1)d.resolutions.shift();a.map.addLayer(new OpenLayers.Layer.WMTS(d)),d.url=h.baseMapURLTxt,d.isBaseLayer=!1,delete d.transitionEffect,a.map.addLayer(new OpenLayers.Layer.WMTS(d))},Q=function(){var a={maxExtent:new OpenLayers.Bounds(-275e4,-9e5,36e5,463e4),restrictedExtent:new OpenLayers.Bounds(-285e4,-1e6,37e5,473e4),maxResolution:"auto",projection:"EPSG:3978",units:"m",displayProjection:new OpenLayers.Projection("EPSG:4269"),aspectRatio:.8,fractionalZoom:!1,tileManager:null};return a},R=function(b,c){var d,e,f=c.basemap,g=f&&0!==f.length;if(g){if(e=f.mapOptions)try{d={maxExtent:new OpenLayers.Bounds(e.maxExtent.split(",")),maxResolution:e.maxResolution,projection:e.projection,restrictedExtent:new OpenLayers.Bounds(e.restrictedExtent.split(",")),units:e.units,displayProjection:new OpenLayers.Projection(e.displayProjection),numZoomLevels:e.numZoomLevels,aspectRatio:e.aspectRatio,tileManager:null}}catch(h){d={},p&&k.trigger("baseMapMapOptionsLoadError"+j)}}else d=Q();b.gmap.height(b.gmap.width()*d.aspectRatio),b.map=new OpenLayers.Map(b.gmap.attr("id"),a.extend(c.config,d)),b.map.controls=[],g?(f.options||(f.options={}),f.options.isBaseLayer=!0,"wms"===f.type?b.map.addLayer(new OpenLayers.Layer.WMS(f.title,f.url,{layers:f.layers,version:f.version,format:f.format},f.options)):"esri"===f.type&&b.map.addLayer(new OpenLayers.Layer.ArcGIS93Rest(f.title,f.url))):(P(b),b.showAttribNRCan=!0)},S=function(c,e){var f,g=e.overlays,h=g.length;0!==h&&(c.overlays=h,a.each(g,function(h,i){var j=i.type,k=i.title,m=i.visible,n=i.url,o=B(h,k,i.caption,i.datatable);"kml"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.KML({extractStyles:!i.style,extractAttributes:!0,internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(c){var e,f,g,h,j,k,l,m,n=0,o=[],p=i.attributes;for("string"==typeof c&&(d.ie?(l=new b.ActiveXObject("Microsoft.XMLDOM"),l.async=!1,l.loadXML(c),c=l):c=(new DOMParser).parseFromString(c,"text/xml")),e=this.getElementsByTagNameNS(c,"*","Placemark"),h=e.length;n!==h;n+=1){f=e[n],g=a(f),j=new OpenLayers.Feature.Vector,j.geometry=this.parseFeature(f).geometry,k={};for(m in p)p.hasOwnProperty(m)&&(k[p[m]]=g.find(m).text());j.attributes=k,o.push(j)}return o}})}),eventListeners:{featuresadded:function(a){K(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&L(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&L(c)},l)}},styleMap:I(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),C(c,o,m,f.id,i.tab),f.visibility=m):"atom"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.Atom({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","entry"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.parseFeature(d),h=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(k=V(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),l=new OpenLayers.Geometry.LinearRing(k),m=new OpenLayers.Geometry.Polygon(l),n=m.transform(u,v),h.geometry=n):h.geometry=this.parseFeature(d).geometry.transform(u,v),j={};for(p in t)t.hasOwnProperty(p)&&(j[t[p]]=e.find(p).text());h.attributes=j,s.push(h)}return s}})}),eventListeners:{featuresadded:function(a){K(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&L(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&L(c)},l)}},styleMap:I(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),C(c,o,m,f.id,i.tab),f.visibility=m):"georss"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.GeoRSS({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","item"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.createFeatureFromItem(d),m=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(h=V(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),j=new OpenLayers.Geometry.LinearRing(h),k=new OpenLayers.Geometry.Polygon(j),l=k.transform(u,v),m.geometry=l):m.geometry=this.parseFeature(d).geometry.transform(u,v),n={};for(p in t)t.hasOwnProperty(p)&&(n[t[p]]=e.find(p).text());m.attributes=n,s.push(m)}return s}})}),eventListeners:{featuresadded:function(a){K(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&L(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&L(c)},l)}},styleMap:I(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),C(c,o,m,f.id,i.tab),f.visibility=m):"json"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:n,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=i.root,p=a[o]?a[o]:a,q=[],r=i.attributes,s=new OpenLayers.Projection("EPSG:4326"),t=c.map.getProjectionObject();for(d=0,e=p.length;d!==e;d+=1){b=p[d],f=new OpenLayers.Feature.Vector,n=b.geometry.coordinates[0],"Polygon"===b.geometry.type&&5===n.length?(j=V(n[1][0],n[1][1],n[3][0],n[3][1]),k=new OpenLayers.Geometry.LinearRing(j),l=new OpenLayers.Geometry.Polygon(k),m=l.transform(s,t),f.geometry=m):f.geometry=this.parseGeometry(b.geometry),g={};for(h in r)r.hasOwnProperty(h)&&(g[r[h]]=b[h]);f.attributes=g,f.geometry&&q.push(f)}return q}})}),eventListeners:{featuresadded:function(a){K(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&L(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&L(c)},l)}},styleMap:I(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),C(c,o,m,f.id,i.tab),f.visibility=m):"geojson"===j&&(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:n,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=a.features,p=[],q=i.attributes,r=new OpenLayers.Projection("EPSG:4326"),s=c.map.getProjectionObject();for(b=0,d=o.length;b!==d;b+=1){e=o[b],f=new OpenLayers.Feature.Vector,n=e.geometry.coordinates[0],"Polygon"===e.geometry.type&&5===n.length?(j=V(n[1][0],n[1][1],n[3][0],n[3][1]),l=new OpenLayers.Geometry.LinearRing(j),k=new OpenLayers.Geometry.Polygon(l),m=k.transform(r,s),f.geometry=m):f.geometry=this.parseGeometry(e.geometry),g={};for(h in q)q.hasOwnProperty(h)&&(g[q[h]]=e.properties[h]);f.attributes=g,f.geometry&&p.push(f)}return p}})}),eventListeners:{featuresadded:function(a){K(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&L(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&L(c)},l)}},styleMap:I(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),C(c,o,m,f.id,i.tab),f.visibility=m)}))},T=function(b,d,e,f){var g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,E,F,G,H,J="<th>"+h.zoomFeature+"</th>",K="<th>"+h.select+"</th>",L=new OpenLayers.Format.WKT({internalProjection:f,externalProjection:e}),M=/<\/?[^>]+>/gi,N=/\W/g;for(H=d.tables.length-1;-1!==H;H-=1){for(i=c.getElementById(d.tables[H].id),g=a(i),j=d.tables[H],k=[],m=new OpenLayers.Layer.Vector(g.find("caption").text(),{styleMap:I(j)}),n=i.getElementsByTagName("th"),p=i.getElementsByTagName("tr"),q=p.length,r=d.useMapControls,o=n.length-1;-1!==o;o-=1)k[o]=n[o].innerHTML.replace(M,"");for(l=g.find("thead tr"),j.zoom&&r&&l.append(J),l.prepend(K),q=p.length-1;-1!==q;q-=1){for(s={},t=p[q],u=t.getAttribute("data-type"),w=t.getElementsByTagName("td"),x=w.length-1;-1!==x;x-=1)y=w[x],z=y.getElementsByTagName("script")[0],z&&z.parentNode.removeChild(z),s[k[x]]=y.innerHTML;if(null!==u){if("bbox"===u){for(A=t.getAttribute("data-geometry").split(","),E=V(A[0],A[1],A[2],A[3]),F="",G=E.length-1;-1!==G;G-=1)F+=E[G].x+" "+E[G].y+", ";F=F.slice(0,-2),B="POLYGON (("+F+"))"}else"wkt"===u&&(B=t.getAttribute("data-geometry"));v=L.read(B),t.setAttribute("id",v.id.replace(N,"_")),v.attributes=s,m.addFeatures([v])}}m.id="#"+j.id,m.datatable=j.datatable,m.popupsInfo=j.popupsInfo,m.popups=j.popups,m.name=j.id,b.map.addLayer(m),b.queryLayers.push(m),j.tab?C(b,g,!0,m.id,j.tab):b.glegend&&D(b,g,!0,m.id)}},U=function(a,b){var d,e,f,g,i,j,k,l,m,n,o,p,q,r=a.gmap,s=a.map,u=h.mouseposition,y=h.scaleline,z=b.useMapControls,A=b.tables,B=A.length,C=a.queryLayers,D=C.length;for(a.selectControl=new OpenLayers.Control.SelectFeature(a.queryLayers,{onSelect:v,onUnselect:w,clickFeature:x}),s.addControl(a.selectControl),a.selectControl.activate(),o=0;o!==B;o+=1)for(i=A[o],j="#"+i.id,n=i.zoom,p=0;p!==D;p+=1)if(k=C[p],k.id===j)for(l=k.features,m=l.length,q=0;q!==m;q+=1)M(a,l[q],n,z);z&&(b.useMousePosition&&(s.addControl(new OpenLayers.Control.MousePosition),d=s.getControlsByClass("OpenLayers.Control.MousePosition")[0].div,d.setAttribute("aria-label",u),d.setAttribute("title",u)),b.useScaleLine&&(s.addControl(new OpenLayers.Control.ScaleLine),e=s.getControlsByClass("OpenLayers.Control.ScaleLine")[0].div,e.setAttribute("aria-label",y),e.setAttribute("title",y)),s.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:!0})),s.addControl(new OpenLayers.Control.KeyboardDefaults),s.getControlsByClass("OpenLayers.Control.KeyboardDefaults")[0].deactivate(),r.attr({tabindex:"0","data-map":a.mapid}),t(a),r.before("<details id='geomap-details-"+a.uniqueId+"' class='wb-geomap-detail' style='width:"+(r.width()-10)+"px;'><summary>"+h.accessTitle+"</summary><p>"+h.access+"</p></details>")),(a.showAttribNRCan||b.attribution)&&(s.addControl(new OpenLayers.Control.Attribution),a.showAttribNRCan?(f=c.createElement("a"),f.setAttribute("href",h.attribLink),g="©"+h.attribTitle):b.attribution.href?(f=c.createElement("a"),f.setAttribute("href",b.attribution.href),g=b.attribution.text):(f=c.createElement("p"),g=b.attribution.text),f.appendChild(c.createTextNode(g)),s.getControlsByClass("OpenLayers.Control.Attribution")[0].div.appendChild(f)),s.zoomToMaxExtent()},V=function(a,b,c,d){var e,f=parseFloat(a),g=parseFloat(b),h=parseFloat(c),i=parseFloat(d),j=[];if(0===f.length||0===g.length||0===h.length||0===i.length)return!1;for(-180===f&&(f+=.1),180===h&&(h=-5),90===i&&(i-=3),-90===g&&(g=35),e=f;h>e;e+=.5)j.push(new OpenLayers.Geometry.Point(e,g));for(j.push(new OpenLayers.Geometry.Point(h,g)),e=h;e>f;e-=.5)j.push(new OpenLayers.Geometry.Point(e,i));return j.push(new OpenLayers.Geometry.Point(f,i)),j.push(new OpenLayers.Geometry.Point(f,g)),j},W=function(a,b){R(a,b);var c=new OpenLayers.Projection("EPSG:4326"),d=a.map.getProjectionObject();p&&k.trigger("projection"+j,d.getCode()),a.selectControl=new OpenLayers.Control.SelectFeature,b.useLegend&&z(),A(a,b.useTab),T(a,b,c,d),S(a,b),U(a,b),a.gmap.attr({role:"dialog","aria-label":h.ariaMap})},X=function(){var a,b,c={};for(b=o.length-1;-1!==b;b-=1)a=o[b],c[a.id]=a;return c},Y=function(a){var b,c;for(c=o.length-1;-1!==c;c-=1)if(b=o[c],b.id===a)return b},Z=function(b){var c=b.glayers;c.find(".wb-tables").trigger("wb-init.wb-tables"),c.find(".wb-geomap-tabs").trigger("wb-init.wb-tabs"),E(b),b.map.id=b.mapid,o.push(b.map),o.length===a(j).length&&(setTimeout(function(){b.gmap.find("img").attr("alt",""),a(".olTileImage").attr("alt","")},2e3),b.map.events.on({moveend:function(){a(".olTileImage").attr("alt","")}}),d.doc.trigger("geomap.ready",[X()]))},$=function(a){var b=Y(a.getAttribute("data-map")),c=b.getLayer(a.getAttribute("data-layer"));return[b,c,c.getFeatureById(a.getAttribute("data-feature"))]};k.on("geomap.wb",j,r),k.on("click",".geomap-zoomto",function(b){var c,d,e=b.which,f=b.target;e&&1!==e||(b.preventDefault(),c=f.getAttribute("data-map"),d=$(f),d[0].zoomToExtent(d[2].geometry.bounds),a("#"+c+" .wb-geomap-map").trigger("setfocus.wb"))}),k.on(d.resizeEvents,function(){if(0!==o.length){var b,c,d,e=X();for(b in e)e.hasOwnProperty(b)&&(c=e[b],d=a(c.div),d.height(.8*d.width()),c.updateSize(),c.zoomToMaxExtent())}}),k.on("change",".geomap-cbx",function(a){var b=a.target,c=$(b)[2];b.checked?x(c):f.selectControl.unselect(c)}),k.on("change",".geomap-lgnd-cbx",function(b){var d=b.target,e=$(d)[1],g=d.value,i=c.getElementById("cb_"+g).checked,j=f.glayers.find("#"+g),k=j.parent(),l=a("#msg_"+g);e.setVisibility(i),k.hasClass("dataTables_wrapper")||(k=j),0!==l.length?l.fadeToggle():k.after("<div id='msg_"+g+"'><p>"+h.hiddenLayer+"</p></div>"),k.css("display",i?"table":"none")}),k.on("mouseenter mouseleave focusin focusout",".wb-geomap-map",function(b){var c,d=b.type,e=b.currentTarget,f=Y(e.getAttribute("data-map")),g="OpenLayers.Control.KeyboardDefaults",h="OpenLayers.Control.Navigation";f&&(c=e.className.indexOf("active"),"mouseenter"===d||"focusin"===d?c||(f.getControlsByClass(g)[0].activate(),f.getControlsByClass(h)[0].activate(),a(e).addClass("active")):c&&(f.getControlsByClass(h)[0].deactivate(),f.getControlsByClass(g)[0].deactivate(),a(e).removeClass("active")))}),k.on("keydown click",".olPopupCloseBox span",function(a){var b=a.which,c=a.currentTarget;"keydown"===a.type?13===b&&$(c)[2].popup.hide():b&&1!==b||Y(c.getAttribute("data-map")).getControlsByClass("OpenLayers.Control.SelectFeature")[0].unselect(e)}),d.add(j)}(jQuery,window,document,wb);